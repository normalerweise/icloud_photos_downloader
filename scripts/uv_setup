#!/usr/bin/env bash
# Complete uv-based development environment setup
set -euo pipefail

echo "ğŸš€ Setting up modern Python development environment with uv..."

# Install uv if not present
if ! command -v uv &> /dev/null; then
    echo "ğŸ“¦ Installing uv..."
    curl -LsSf https://astral.sh/uv/install.sh | sh
    export PATH="$HOME/.cargo/bin:$PATH"
    echo "âœ… uv installed successfully"
else
    echo "âœ… uv is already installed"
fi

# Show uv version
echo "ğŸ“‹ uv version: $(uv --version)"

# Create/update virtual environment and install dependencies
echo "ğŸ“¦ Installing project dependencies..."
uv sync --all-extras

echo "ğŸ” Verifying installation..."
uv run python --version
uv run python -c "import icloudpd; print('âœ… icloudpd package imported successfully')"

echo "ğŸ§ª Running quick test suite..."
uv run python -m pytest tests/ -x -q --tb=short || echo "âš ï¸  Some tests failed (expected for new installation)"

echo ""
echo "ğŸ‰ Development environment ready!"
echo ""
echo "ğŸ“š Available commands:"
echo "  uv run python test_phase3.py          # Test functional integration"
echo "  uv run python test_phase4.py          # Test state management"  
echo "  uv run python test_phase5_integration.py  # Test production features"
echo "  uv run ruff check                     # Lint code"
echo "  uv run ruff format                    # Format code"
echo "  uv run pyright                        # Type check"
echo "  uv run pytest                         # Run full test suite"
echo ""
echo "ğŸ”§ Development scripts:"
echo "  scripts/lint                          # Lint and format"
echo "  scripts/type_check                    # Type checking"
echo "  scripts/test                          # Full test suite"
echo ""
echo "ğŸŒŸ Modern Python tooling configured:"
echo "  âœ… uv (package management)"
echo "  âœ… ruff (linting & formatting)"
echo "  âœ… pyright (type checking)"
echo "  âœ… pytest (testing)"
echo ""